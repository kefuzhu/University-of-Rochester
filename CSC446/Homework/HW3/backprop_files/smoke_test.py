#!/usr/bin/env python3
from __future__ import print_function #in case somebody tries to run this file with Python 2
import sys
import os

DATA_DIR = '/u/cs246/data/adult/' #TODO: change this to wherever you put the data if working on a different machine

def err(msg):
    print('ERROR: {}'.format(msg), file=sys.stderr)
    exit()

def find_filenames():
    return [fn for fn in os.listdir('.') if os.path.isfile(fn) and fn.endswith('_backprop.py')]

def get_output(filename):
    import subprocess
    cmd = './{} --nodev --iterations 1 --weights_files w1.txt w2.txt --lr 0.01 --train_file {} --test_file {} --print_weights'.format(filename, os.path.join(DATA_DIR, 'a7a.train'), os.path.join(DATA_DIR, 'a7a.test'))
    print('Running this command:\n{}'.format(cmd))
    try:
        output = subprocess.check_output(cmd.split()).decode('utf-8')
    except subprocess.CalledProcessError:
        err('Python file did not exit successfully (likely crashed).')
    except OSError as e:
        if e.errno == 13:
            err('Python file is not executable; run this command:\nchmod u+x {}'.format(filename))
        elif e.errno == 8:
            err('Python file does not start with a shebang; put this line at the very top:\n#!/usr/bin/python3\n(Replace python3 with python if using Python 2)')
        elif e.errno == 2:
            err('Unable to execute python file; if you ever edited the file on Windows, it is possible that the line endings are wrong, so try running this command:\ndos2unix {}\nOtherwise, you\'ll have to take a look at it and see what went wrong.'.format(filename))
        else:
            print('Got an OS error not caused by permissions or a shebang problem; you\'ll have to take a look at it and see what the problem is. See below:')
            raise e

    return output

def tokens(s):
    result = []
    for tok in s.split():
        try:
            result.append(float(tok))
        except ValueError as e:
            result.append(tok)
    return result


def round_to_sigfigs(num, sigfigs):
    from math import log10, floor
    if num == 0:
        return num
    else:
        return round(num, -int(floor(log10(abs(num)))) + sigfigs - 1)

def fuzzy_match(line, req):
    line_toks = tokens(line)
    if len(line_toks) != len(req):
        return False
    else:
        for l,r in zip(line_toks, req):
            if type(l) != type(r):
                return False
            elif type(l) == str and l != r:
                return False
            elif type(l) == float and round_to_sigfigs(l,6) != round_to_sigfigs(r,6): #float
                return False
        return True

def verify_output(output):
    acc_req = tokens('Test accuracy: 0.75676633')
    got_acc = False
    hidden_weight_req1 = tokens('Hidden layer weights: -7.587128081140093183e-02 -2.851198562100766276e-01 -2.458799097922665100e-01 -1.206168448525961473e-01 -2.254704482147051048e-01 1.144575440297924268e-01 -2.380903349808325409e-01 4.343860931364731393e-01 2.178136018556495745e-01 -3.880887477779892958e-01 -1.142595511286133292e-01 1.288025404837349619e-01 -3.747110279525127097e-01 4.854848706729084640e-01 -3.194018344508332830e-02 2.942579393096590445e-01 3.099538806875649088e-01 -1.181554774835438942e-01 -1.486853868452551186e-01 1.062074863031414046e-01 2.877847433384892462e-01 -1.963910621550022662e-01 -2.332702841192472176e-01 1.660695003031816830e-01 -1.006863318945117915e-02 -3.100867685486420888e-01 -7.363327739753176837e-02 -2.893905414019578015e-01 -1.457082377707730886e-02 3.362717971382304660e-01 -2.924869329084968106e-01 4.334148017792041063e-01 -6.564681979191702710e-02 5.754974747583446910e-03 1.109177819565820844e-01 -3.684080153696026039e-01 2.536394268604446056e-01 4.794387874723133325e-01 -4.935638743339389456e-01 -6.363637067314317219e-01 -6.167059999000285009e-02 4.211332855115074714e-01 -4.775539039226217586e-01 -1.168361511549659004e-01 -4.347884368515392839e-01 2.888024903633233387e-01 -1.519164605178339733e-01 2.198747831314035173e-01 6.076605398443690742e-02 4.542571745497514524e-01 2.411084916453116733e-01 4.298873608890368958e-02 9.482436818284517566e-02 5.270979196595737548e-01 -1.989902537994827636e-01 -4.695393248084763771e-01 -3.986261370837628215e-01 4.421089587488229444e-01 4.668426903808069461e-01 -8.483648261539742871e-03 -2.022783690388948175e-01 3.524716352952412812e-01 -7.111374640972831784e-01 3.763626301879511860e-01 1.938921138510046327e-01 -2.449296389661803908e-01 1.886412125122451933e-01 4.096306859497225172e-01 -3.342158950894220104e-01 4.149216714675890150e-01 -1.364479092910379499e-01 3.336227965126425943e-01 -2.999849724231883341e-01 1.651156455012219582e-01 -4.007999445138776262e-01 7.064239076637465753e-02 -8.594283387715688505e-02 6.895428997511723716e-03 3.091452334535949031e-01 7.035798761304958016e-02 2.013756069180713815e-01 1.784740339161122180e-01 -1.034131526343571861e-01 4.091115188400234470e-01 2.116969022727984984e-01 3.992434016142778486e-01 -8.148834842828105163e-02 -3.217253915911298667e-02 4.042709793330491741e-01 1.332389374358097789e-01 3.180757442338441598e-02 -2.626856066407144419e-01 4.465142661491474652e-01 5.929893568116818142e-02 2.568570819894582802e-01 -2.638190762018108315e-01 -6.983303463864558303e-02 -1.072030757190580996e-01 1.089831219280613765e-02 -3.735494425318868217e-01 1.843906151374493652e-01 -4.709865727849686379e-01 -2.511465512521264265e-01 2.366107131589855750e-01 4.343335508639591946e-01 1.135008978340181079e-01 -9.107909975171565864e-02 3.542697442541714037e-01 4.923840362580739205e-01 -2.046466640047443775e-01 -1.095180844853641672e-01 2.004194666038414396e-01 -1.430423942183356445e-01 -4.667523686597268018e-01 -1.501398127407828909e-01 -1.529935097201673248e-02 -4.515090720669208690e-01 4.141029358733496202e-01 2.273854021586649288e-01 2.728543221005788055e-01 -4.031614640295450580e-01 -4.625373464690717418e-01 -2.401873745593388065e-01 -3.066031920956020507e-01')
    got_hw1 = False
    hidden_weight_req2 = tokens('-8.473717679579564899e-02 2.379424024635204415e-01 -5.365227280713647656e-02 3.213974314105955687e-01 1.268701309068059717e-02 -2.422452399530289069e-01 -3.155061112566108772e-01 -2.068702163756083734e-01 -9.021105542210763883e-02 -4.355920876514868811e-01 1.277535329153868526e-01 -4.412886386191480770e-01 2.239089697367293574e-01 1.605350985755037985e-01 -4.725679232318541478e-01 2.528658811762049541e-01 -1.511054792625700915e-01 2.714076875265474809e-01 -2.684001139439944339e-01 1.068238794451167456e-01 -2.993556411670198480e-01 4.511401498133444932e-01 -2.631774664521176477e-01 2.441053998536113490e-01 5.685961303665888755e-02 4.141913973199169985e-01 6.455892321346695661e-02 -4.641915902473388589e-01 -4.762033563307584982e-01 4.602028237603745242e-01 -1.934267341356863540e-02 -3.794754775567543703e-01 1.858982239385011670e-01 1.258060278880553939e-01 1.622272357376927654e-01 5.106728352299368945e-01 4.246006754228378033e-01 -2.446914399188915290e-01 -2.785983377528529828e-03 -3.409704792485652169e-01 -1.583944684541114811e-01 -2.011123308952161848e-01 -2.745988915667256225e-01 1.518996288539541661e-01 -2.067171908044609097e-01 -5.799672659044779327e-02 -1.610337030289795690e-01 1.456413442683358178e-02 2.299740052435251814e-01 4.224903839742554235e-01 -5.677648911307032753e-01 -4.739357068528429057e-02 1.739202874442875302e-01 -3.119912321729135796e-01 2.650673721627060941e-01 -9.934167793751162712e-02 2.500322256408522154e-02 8.162970864492133383e-02 3.342072356843892034e-01 2.018599291874446366e-01 8.245691891001044604e-02 -3.092599417165466935e-01 -7.360803540792969502e-01 1.483316549023167008e-01 3.055533538067745636e-01 2.647653517774542498e-01 -3.272727015708539189e-01 -2.301870017298614235e-01 -2.800329681936852277e-01 -8.655471450108070952e-02 1.854726469064409411e-01 -9.611433477927162905e-02 -3.389325933615843223e-01 4.143211900468387054e-01 2.337537262840574392e-01 1.090599629508829799e-01 1.766791349289373869e-01 5.708779689755830861e-02 3.380811000848295000e-01 3.658953413481811912e-01 -5.053007042091930412e-01 8.603771384828051705e-02 2.046684621897210121e-01 2.187883565031439326e-01 2.848589378154972596e-01 4.391359962844262332e-01 1.562750416519691488e-01 -3.122258929995638255e-01 1.885441754318313845e-01 4.903458423667934607e-01 4.132640842393165981e-01 3.649990164088806055e-01 -4.531576307482481636e-01 -4.918235479887048123e-01 2.490402890630649124e-01 2.333704109003702787e-01 2.088787639620208469e-01 -3.451804423817275702e-01 -3.813751739609603786e-01 -3.383304635544904793e-01 3.238951530878137475e-01 -9.476272657431433766e-02 -3.025272990083405222e-01 1.319596586769779534e-01 -4.617386494347787695e-01 -4.058940003114602235e-01 -3.866070091380429119e-01 1.899297865411062047e-01 1.170350950278410129e-01 7.360193816317697757e-02 3.264108333106627291e-01 2.463753636532796665e-01 -2.733625838551998477e-01 -4.107265923028409760e-01 1.842789793529592138e-03 -1.864593611217932601e-01 -2.316822419233346142e-01 8.598467157440618097e-03 2.038613417856818821e-01 4.073970619480178357e-01 -4.566137886077550195e-02 3.318678966609570763e-02 3.088151916771204597e-01 -9.658624936738965938e-02')
    got_hw2 = False
    output_weight_req = tokens('Output layer weights: -9.648801328484960527e-01 -8.763606419228865407e-01 -3.002193791029223457e-01')
    got_ow = False
    for line in output.split('\n'):
        if fuzzy_match(line, acc_req):
            print('Test accuracy is correct!')
            got_acc = True
        elif fuzzy_match(line, hidden_weight_req1):
            print('Hidden weights, first line is correct!')
            got_hw1 = True
        elif fuzzy_match(line, hidden_weight_req2):
            print('Hidden weights, second line is correct!')
            got_hw2 = True
        elif fuzzy_match(line, output_weight_req):
            print('Output weights are correct!')
            got_ow = True
    if not (got_acc and got_hw1 and got_hw2 and got_ow):
        err('Unable to find one or more required output lines. Make sure each is on its own line and formatted correctly; if so, then there is an implementation problem. This should have produced (with all numbers matched to 6 significant figures):\n{}\n{}\n{}\n{}\n\n'.format(' '.join(map(str,acc_req)),' '.join(map(str,hidden_weight_req1)),' '.join(map(str,hidden_weight_req2)),' '.join(map(str,output_weight_req))))

def main():
    filenames = find_filenames()
    if len(filenames) == 0:
        err('No files ending in \'_backprop.py\' found. Make sure your file is named LastName_backprop.py.')
    if len(filenames) > 1:
        err('Only include a single file ending in \'_backprop.py\' in the submission directory.')
    print('Found Python file to run.')
    if not os.path.exists(DATA_DIR):
        err('Could not find the data directory; looked for {}. Change the DATA_DIR variable at the top of this smoke test file to wherever you have downloaded the data (a7a.*).'.format(DATA_DIR))
    print('Found data directory.')
    output = get_output(filenames[0])
    print('Ran Python file.')
    verify_output(output)
    print('Congratulations, you passed this simple test! However, make sure that your code runs on the csug server. Also, don\'t forget your README!')

if __name__ == '__main__':
    main()
